<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luxuria Rate Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans">
    <nav class="bg-indigo-900 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <i class="fas fa-hotel text-2xl text-yellow-400"></i>
                <h1 class="font-bold text-lg">Luxuria Monitor <span class="text-xs text-indigo-300 font-normal ml-1">Live Inventory</span></h1>
            </div>
            <span id="status-badge" class="text-xs bg-indigo-800 px-3 py-1 rounded-full">System Ready</span>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <div class="flex justify-between items-end mb-6">
            <h2 class="text-2xl font-bold text-slate-800">Market Overview</h2>
            <!-- Dynamic Update Link -->
            <a id="update-link" href="#" target="_blank" class="hidden md:inline-flex items-center bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 px-4 py-2 rounded shadow-sm text-sm">
                <i class="fas fa-sync-alt mr-2 text-indigo-500"></i> Check Actions
            </a>
        </div>

        <div id="inventory-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
             <div class="col-span-full text-center py-20 text-slate-500 bg-white rounded-lg border border-slate-200 shadow-sm">
                <i id="loading-icon" class="fas fa-circle-notch fa-spin text-4xl mb-4 text-indigo-500"></i>
                <h3 id="loading-text" class="text-lg font-bold text-slate-700">Connecting to Database...</h3>
                <p id="loading-sub" class="text-sm text-slate-400 mt-2">Please wait.</p>
            </div>
        </div>
    </div>

    <script>
        const MY_HOTEL_KEYWORD = "Luxuria";
        
        // Auto-configure the Actions Link
        const user = window.location.host.split('.')[0];
        const repo = window.location.pathname.split('/')[1];
        if(user && repo) {
            document.getElementById('update-link').href = `https://github.com/${user}/${repo}/actions`;
        }

        // --- MOCK DATA FOR PREVIEW ---
        // This runs if prices.json is missing (like in this preview)
        function getMockData() {
            return [{
                "date": new Date().toLocaleString(),
                "data": {
                    "Luxuria by Moustache": { "Deluxe Room": 3500, "Super Deluxe": 4200, "Royal Suite": 6500 },
                    "Minimalist Varanasi": { "Standard": 3800, "Studio": 4500 },
                    "Quality Inn Varanasi": { "Standard King": 4000, "Club Twin": 5200 },
                    "Hotel Balaji Palace": { "Standard Room": 2800 },
                    "Pearl Courtyard": { "Deluxe Double": 3200 },
                    "Hotel Veda Vatica": { "Heritage Room": 4500 },
                    "Hotel Hardik": { "Standard Room": 2500 },
                    "Hotel Dolphin": { "Standard": 3000 },
                    "Coco Cabana": { "Luxury Tent": 2000 }
                }
            }];
        }

        async function loadData() {
            const statusBadge = document.getElementById('status-badge');
            const loadingText = document.getElementById('loading-text');
            const loadingSub = document.getElementById('loading-sub');

            try {
                let history = [];
                
                // 1. Try Fetching Data
                try {
                    const response = await fetch('prices.json');
                    if (response.ok) {
                        history = await response.json();
                    } else {
                        throw new Error("File not found");
                    }
                } catch (fetchError) {
                    // If fetch fails (Preview Mode), use Mock Data
                    console.warn("Could not load prices.json. Using Mock Data for Preview.");
                    history = getMockData();
                    statusBadge.innerText = "Preview Mode";
                    statusBadge.className = "text-xs bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full";
                }

                // 2. Check if Empty (real data might be empty [])
                if (!history || history.length === 0) {
                    statusBadge.innerText = "No Data";
                    statusBadge.className = "text-xs bg-red-100 text-red-800 px-3 py-1 rounded-full";
                    loadingText.innerText = "Database is Empty";
                    loadingSub.innerHTML = `The scraper hasn't run yet.<br><a href="${document.getElementById('update-link').href}" class="text-blue-500 underline">Click here to Run Scraper</a>`;
                    document.getElementById('loading-icon').className = "fas fa-database text-4xl mb-4 text-red-300";
                    return;
                }

                // 3. Render Data
                renderInventory(history);

            } catch (e) {
                console.error(e);
                statusBadge.innerText = "Error";
                statusBadge.className = "text-xs bg-red-600 text-white px-3 py-1 rounded-full";
                loadingText.innerText = "System Error";
                loadingSub.innerText = "Could not load data.";
            }
        }

        function renderInventory(history) {
            const latest = history[history.length - 1];
            // Only update date if not in preview/mock mode to avoid confusion, or show mock date
            if (document.getElementById('status-badge').innerText !== "Preview Mode") {
                 document.getElementById('status-badge').innerText = `Updated: ${latest.date}`;
            }
            
            const grid = document.getElementById('inventory-grid');
            grid.innerHTML = '';
            
            const hotelData = latest.data || latest.prices;

            // Sort: My Hotel First
            const entries = Object.entries(hotelData).sort((a, b) => {
                return b[0].includes(MY_HOTEL_KEYWORD) - a[0].includes(MY_HOTEL_KEYWORD);
            });

            entries.forEach(([name, inventory]) => {
                const isMine = name.includes(MY_HOTEL_KEYWORD);
                const border = isMine ? "border-2 border-blue-500 ring-4 ring-blue-50" : "border border-slate-200";
                const bg = isMine ? "bg-blue-600 text-white" : "bg-slate-50 text-slate-700";
                
                let listHtml = '', lowest = Infinity, count = 0;
                
                if (!inventory || Object.keys(inventory).length === 0) {
                     lowest = 0;
                     listHtml = `<li class="text-center text-red-400 text-sm italic py-4">No rates available</li>`;
                } else {
                    Object.entries(inventory).sort((a,b) => a[1]-b[1]).forEach(([room, price]) => {
                        count++;
                        if (count===1) lowest = price;
                        const rowClass = count===1 ? (isMine ? "bg-blue-50 -mx-5 px-5" : "bg-green-50 -mx-5 px-5") : "";
                        const priceClass = count===1 ? "font-bold text-slate-900" : "text-slate-600";
                        
                        listHtml += `<li class="flex justify-between py-2 border-b border-slate-100 last:border-0 ${rowClass}">
                            <span class="text-sm truncate w-2/3" title="${room}">${room}</span>
                            <span class="${priceClass}">₹${price.toLocaleString()}</span>
                        </li>`;
                    });
                }

                grid.innerHTML += `
                    <div class="bg-white rounded-xl overflow-hidden hover:shadow-lg transition-all ${border}">
                        <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center ${bg}">
                            <h3 class="font-bold truncate w-2/3" title="${name}">${name}</h3>
                            <span class="text-sm font-bold px-3 py-1 rounded bg-white text-slate-700 shadow-sm">
                                ${lowest > 0 ? '₹'+lowest.toLocaleString() : 'N/A'}
                            </span>
                        </div>
                        <div class="p-5">
                            <ul class="space-y-1 max-h-60 overflow-y-auto custom-scroll pr-1">${listHtml}</ul>
                        </div>
                    </div>`;
            });
        }
        loadData();
    </script>
</body>
</html>
